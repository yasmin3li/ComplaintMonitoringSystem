-- ===============================================
-- DROP DATABASE IF EXISTS
-- ===============================================
DROP DATABASE IF EXISTS complaint_monitoring_sys;

-- ===============================================
-- CREATE DATABASE
-- ===============================================
CREATE DATABASE IF NOT EXISTS complaint_monitoring_sys;
USE complaint_monitoring_sys;

SET FOREIGN_KEY_CHECKS = 0;

-- ===============================================
-- DROP TABLES
-- ===============================================
DROP TABLE IF EXISTS voting;
DROP TABLE IF EXISTS rating;
DROP TABLE IF EXISTS complaint_image;
DROP TABLE IF EXISTS complaint_tracking_log;
DROP TABLE IF EXISTS complaint;
DROP TABLE IF EXISTS employee;
DROP TABLE IF EXISTS citizen;
DROP TABLE IF EXISTS service;
DROP TABLE IF EXISTS address;
DROP TABLE IF EXISTS institution_governorate;
DROP TABLE IF EXISTS institution;
DROP TABLE IF EXISTS sector_governorate;
DROP TABLE IF EXISTS sector;
DROP TABLE IF EXISTS account;
DROP TABLE IF EXISTS governorate;
DROP TABLE IF EXISTS role;
DROP TABLE IF EXISTS refreshToken;
DROP TABLE IF EXISTS password_reset_token;
DROP TABLE IF EXISTS verification_code;
-- ===============================================
-- TABLE: Role
CREATE TABLE role (
    id BIGINT NOT NULL PRIMARY KEY AUTO_INCREMENT,
    name VARCHAR(100) UNIQUE NOT NULL
) ENGINE=InnoDB;

-- TABLE: Governorate
CREATE TABLE governorate (
    id BIGINT NOT NULL PRIMARY KEY AUTO_INCREMENT,
    name VARCHAR(200) NOT NULL
) ENGINE=InnoDB;

-- TABLE: Sector
CREATE TABLE sector (
    id BIGINT NOT NULL PRIMARY KEY AUTO_INCREMENT,
    name VARCHAR(200) NOT NULL
) ENGINE=InnoDB;

-- TABLE: Sector_Governorate
CREATE TABLE sector_governorate (
    id BIGINT NOT NULL PRIMARY KEY AUTO_INCREMENT,
    sector_id BIGINT NOT NULL,
    governorate_id BIGINT NOT NULL,
    FOREIGN KEY (sector_id) REFERENCES sector(id),
    FOREIGN KEY (governorate_id) REFERENCES governorate(id)
) ENGINE=InnoDB;

-- TABLE: Institution
CREATE TABLE institution (
    id BIGINT NOT NULL PRIMARY KEY AUTO_INCREMENT,
    name VARCHAR(200) NOT NULL,
    sector_id BIGINT NOT NULL,
    FOREIGN KEY (sector_id) REFERENCES sector(id)
) ENGINE=InnoDB;

-- TABLE: Institution_Governorate
CREATE TABLE institution_governorate (
    id BIGINT NOT NULL PRIMARY KEY AUTO_INCREMENT,
    institution_id BIGINT NOT NULL,
    sector_governorate_id BIGINT NOT NULL,
    FOREIGN KEY (institution_id) REFERENCES institution(id),
    FOREIGN KEY (sector_governorate_id) REFERENCES sector_governorate(id)
) ENGINE=InnoDB;

-- TABLE: Account
CREATE TABLE account (
    id BIGINT NOT NULL PRIMARY KEY AUTO_INCREMENT,
    user_name VARCHAR(100) NOT NULL,
    email VARCHAR(255) UNIQUE,
    password VARCHAR(500) NOT NULL,
    status VARCHAR(50) NOT NULL DEFAULT 'BANNED',
    deleted BOOLEAN NOT NULL DEFAULT FALSE,
    phone_number varchar(10) NOT NULL,
    profile_image_url VARCHAR(500),
    email_temporary boolean,
    email_verified boolean,
	must_change_password boolean,
    national_number VARCHAR(20) UNIQUE NOT NULL,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    role_id BIGINT NOT NULL,
    FOREIGN KEY (role_id) REFERENCES role(id)
) ENGINE=InnoDB;

-- TABLE: Citizen (linked to Account)
CREATE TABLE citizen (
    id BIGINT NOT NULL PRIMARY KEY,
    birth_date DATE,
    FOREIGN KEY (id) REFERENCES account(id)
) ENGINE=InnoDB;

-- TABLE: Employee (linked to Account)
CREATE TABLE employee (
    id BIGINT NOT NULL PRIMARY KEY,
    institution_id BIGINT NOT NULL,
    FOREIGN KEY (id) REFERENCES account(id),
    FOREIGN KEY (institution_id) REFERENCES institution(id)
) ENGINE=InnoDB;




-- Table refreshToken  password_reset_token  refresh_token
create Table verification_code (
id bigint auto_increment primary key ,
verification_code text ,
verification_code_expire_time datetime ,
is_used boolean,
account_id bigint ,
FOREIGN KEY ( account_id ) REFERENCES account ( id)
-- ON UPDATE CASCADE
--     ON DELETE CASCADE
) ;

create table password_reset_token(
id bigint auto_increment primary key ,
token varchar(10000),
expiry_date datetime ,
account_id bigint ,
FOREIGN KEY ( account_id ) REFERENCES account ( id)
);

create table refresh_token(
id bigint auto_increment primary key ,
refresh_token varchar(10000),
revoked boolean ,
account_id bigint ,
FOREIGN KEY ( account_id ) REFERENCES account ( id)
);




-- TABLE: Address
CREATE TABLE address (
    id BIGINT NOT NULL PRIMARY KEY AUTO_INCREMENT,
    latitude DOUBLE NOT NULL,
    longitude DOUBLE NOT NULL,
    full_address_text VARCHAR(500)
) ENGINE=InnoDB;

-- TABLE: Service
CREATE TABLE service (
    id BIGINT NOT NULL PRIMARY KEY AUTO_INCREMENT,
    name VARCHAR(200) UNIQUE NOT NULL,
    description TEXT,
    is_active BOOLEAN DEFAULT TRUE,
    institution_id BIGINT NOT NULL,
    FOREIGN KEY (institution_id) REFERENCES institution(id)
) ENGINE=InnoDB;

-- TABLE: Complaint
CREATE TABLE complaint (
    id BIGINT NOT NULL PRIMARY KEY AUTO_INCREMENT,
    title VARCHAR(300) NOT NULL,
    description TEXT,
    state VARCHAR(50) NOT NULL DEFAULT 'NEW',
    date_time_of_add DATETIME DEFAULT CURRENT_TIMESTAMP,
    date_time_of_solve DATETIME,
    deleted BOOLEAN NOT NULL DEFAULT FALSE,
    added_by_account_id BIGINT NOT NULL,
    service_id BIGINT NOT NULL,
    institution_id BIGINT NOT NULL,
    governorate_id BIGINT NOT NULL,
    sector_id BIGINT NOT NULL,
    address_id BIGINT NOT NULL,
    FOREIGN KEY (added_by_account_id) REFERENCES account(id),
    FOREIGN KEY (service_id) REFERENCES service(id),
    FOREIGN KEY (institution_id) REFERENCES institution(id),
    FOREIGN KEY (governorate_id) REFERENCES governorate(id),
    FOREIGN KEY (sector_id) REFERENCES sector(id),
    FOREIGN KEY (address_id) REFERENCES address(id)
) ENGINE=InnoDB;


-- TABLES: Complaint Image, Tracking, Rating, Voting
CREATE TABLE complaint_image (
    id BIGINT NOT NULL PRIMARY KEY AUTO_INCREMENT,
    description TEXT,
    image_url VARCHAR(500),
    complaint_id BIGINT NOT NULL,
    FOREIGN KEY (complaint_id) REFERENCES complaint(id) ON DELETE CASCADE
) ENGINE=InnoDB;

CREATE TABLE complaint_tracking_log (
    id BIGINT NOT NULL PRIMARY KEY AUTO_INCREMENT,
    previous_status VARCHAR(50),
    new_status VARCHAR(50),
    action_type VARCHAR(50),
    comments TEXT,
    action_date DATETIME DEFAULT CURRENT_TIMESTAMP,
    complaint_id BIGINT NOT NULL,
    action_by_employee_id BIGINT,
    assigned_to_employee_id BIGINT,
    FOREIGN KEY (complaint_id) REFERENCES complaint(id) ON DELETE CASCADE,
    FOREIGN KEY (action_by_employee_id) REFERENCES employee(id),
    FOREIGN KEY (assigned_to_employee_id) REFERENCES employee(id)
) ENGINE=InnoDB;


CREATE TABLE rating (
    id BIGINT NOT NULL PRIMARY KEY AUTO_INCREMENT,
    rating_value INT,
    note TEXT,
    date_time_of_rating DATETIME DEFAULT CURRENT_TIMESTAMP,
    complaint_id BIGINT NOT NULL,
    account_id BIGINT NOT NULL,
    FOREIGN KEY (complaint_id) REFERENCES complaint(id),
    FOREIGN KEY (account_id) REFERENCES account(id)
) ENGINE=InnoDB;

CREATE TABLE voting (
    id BIGINT NOT NULL PRIMARY KEY AUTO_INCREMENT,
    type VARCHAR(50),
    date_time_of_voting DATETIME DEFAULT CURRENT_TIMESTAMP,
    complaint_id BIGINT NOT NULL,
    account_id BIGINT NOT NULL,
    FOREIGN KEY (complaint_id) REFERENCES complaint(id),
    FOREIGN KEY (account_id) REFERENCES account(id)
) ENGINE=InnoDB;

SET FOREIGN_KEY_CHECKS = 1;


-- ===============================================
-- INSERTS (Modified for Entities)
-- ===============================================

-- Roles
INSERT INTO role (name) VALUES
('مواطن'),
('موظف الاستقبال'),
('مدير'),
('أدمن');

-- Governorates
INSERT INTO governorate (name) VALUES
('دمشق'),
('حماه'),
('حمص'),
('اللاذقية');

-- Sectors
INSERT INTO sector (name) VALUES
('الكهرباء والطاقة'),
('المياه والصرف الصحي'),
('الاتصالات وتقنية المعلومات'),
('الطرق والنقل'),
('النظافة وإدارة النفايات'),
('الزراعة والري');

-- Sector_Governorate
INSERT INTO sector_governorate (sector_id, governorate_id) VALUES
(1, 1),(1, 2),
(2, 1),(2, 2),(2, 3),
(3, 1),(3, 4),
(4, 2),(4,3),
(5,1),(5,4),
(6,2),(6,3);

-- Institutions
INSERT INTO institution (name, sector_id) VALUES
('شركة الكهرباء العامة',1),
('مديرية نقل الطاقة',1),
('مؤسسة مياه الشرب',2),
('مؤسسة الصرف الصحي',2),
('شركة الاتصالات الأرضية',3),
('شركة الاتصالات الخلوية',3),
('مركز خدمات الإنترنت',3),
('مديرية الطرق المركزية',4),
('مديرية النقل البري',4),
('مؤسسة تعبيد وصيانة الطرق الريفية',4),
('مديرية النظافة',5),
('ورشات جمع القمامة المتعاقدة',5),
('مؤسسة استصلاح الأراضي',6);

-- Institution_Governorate
INSERT INTO institution_governorate (institution_id, sector_governorate_id) VALUES
(1,1),(1,2),
(3,2),(3,3),
(4,2),(4,3),
(5,1),(5,12),
(11,1),(11,12);

-- Accounts
INSERT INTO account (user_name,password,role_id,email,phone_number,national_number,status,deleted,email_temporary,must_change_password,email_verified )
 VALUES
 -- YASMEN@bu3li1 ->5->  "NewPass@123"
('ahmad.khaled','$2a$10$VXBtqM71drDqgxpQInQvIuRWSHO8NBeliEabr2OEH2duxTtb1eG9G',
1,'ahmad@example.com','0999999999','05010565489','BANNED',FALSE,FALSE,FALSE,false),

('sara.mohamed','$2a$10$I8p/LuzVrg0pMZ3j2D6TCegw2P8I3MhecJHMCYCe0PqF0NGUtCx6.',
1,'sara@example.com','0999998888','05010565789','BANNED',FALSE,FALSE,true,false),

('reception1','$2a$10$PvOjmBfjgArkJ4U2tdYFKOZiGDfJ.SSDsBAUw0sXRPbmUqtpFqSQG',
2, 'reception1@example.com','0999977777','05010585489','BANNED',FALSE,FALSE,true,false),

('manager1','$2a$10$IKb9sbyBDqO2LP2T.Uc1N.WStHROH.qiiNIxK8efRalbvGLanoneK',
3,'manager1@example.com','0999966666','05010556489','BANNED',FALSE,FALSE,FALSE,false),

('admin1','$2a$10$gEJImlffyEScVA9g0qOLEemEBmHCeWAhVHqCqEb1KAaRFw/cP6l.6',
4,'admin1@example.com','0999955555','05010563389','ACTIVATED',FALSE,FALSE,FALSE,true);

-- $2a$10$H.SkwzXI/5nCHLjGydB7XOXC9Fxlmtslr3Lauel5aWS/zTJI/WUIK    'reception1@example.com'
-- Citizen (linked to account)
INSERT INTO citizen (id,birth_date) VALUES
(1,'1990-01-01'),
(2,'1992-02-02');

-- Employee (linked to account and institution)
INSERT INTO employee (id,institution_id) VALUES
(3,1),
(4,3),
(5,11);

-- Services
INSERT INTO service (name,institution_id,description) VALUES
('صيانة الاعطال في المنازل',1,'صيانة أعطال الكهرباء المنزلية'),
('اصلاح انقطاع التيار',1,'اصلاح الانقطاع الكهربائي'),
('معالجة شكاوى انقطاع المياه',3,'خدمة معالجة الانقطاع'),
('معالجة انخفاض ضغط المياه',3,'خدمة معالجة انخفاض الضغط');

-- Addresses
INSERT INTO address (latitude, longitude, full_address_text) VALUES
(33.5138, 36.2765, 'دمشق - منطقة القنوات'),
(34.7333, 36.7167, 'حماه - حي العمال'),
(34.7333, 36.7167, 'حمص - شارع الملكي'),
(35.5400, 35.8100, 'اللاذقية - منطقة الساحل'),
(33.5200, 36.3000, 'دمشق - شارع الثورة'),
(34.7300, 36.7000, 'حماه - شارع الصناعة'),
(34.7300, 36.7100, 'حمص - منطقة الجلاء'),
(35.5500, 35.8000, 'اللاذقية - شارع الفردوس');

-- Complaints
INSERT INTO complaint 
(title, description, state, deleted, added_by_account_id, service_id, institution_id, governorate_id, sector_id, address_id) 
VALUES
('انقطاع التيار الكهربائي','انقطاع الكهرباء في المنزل منذ يومين','NEW',FALSE,1,2,1,1,1,1),
('مشكلة في ضغط المياه','ضغط المياه منخفض في الحي','NEW',FALSE,2,4,3,2,2,2),
('صيانة الأعطال','أعطال كهربائية في المصانع','NEW',FALSE,1,1,1,1,1,3),
('انقطاع الانترنت','انقطاع الانترنت منذ الصباح','NEW',FALSE,1,3,5,1,3,4),
('تأخر جمع النفايات','النفايات لم تجمع منذ أسبوع','NEW',FALSE,2,4,11,1,5,5),
('مشروع استصلاح أرض','الأراضي بحاجة لمعالجة عاجلة','NEW',FALSE,2,3,13,2,6,6),
('انقطاع المياه الساخنة','المياه الساخنة لا تعمل','NEW',FALSE,1,4,3,2,2,7),
('انقطاع الكهرباء المتكرر','انقطاع الكهرباء بشكل متكرر','NEW',FALSE,2,1,1,1,1,8);

-- Complaint Tracking Log (action_type values reflect enum: ASSIGN, STATE_CHANGED, CHECK, SOLVE, etc.)
INSERT INTO complaint_tracking_log 
(previous_status, new_status, action_type, comments, complaint_id, action_by_employee_id, assigned_to_employee_id) 
VALUES
('NEW','IN_PROGRESS','ASSIGN','تم تعيين الشكوى للموظف المختص',1,4,3),
('NEW','IN_PROGRESS','ASSIGN','تم تعيين الشكوى للموظف المختص',2,4,5),
('IN_PROGRESS','REVIEW','CHECK','تم مراجعة الشكوى',1,4,3),
('IN_PROGRESS','DONE','SOLVE','تم حل الشكوى بنجاح',3,4,3),
('NEW','IN_PROGRESS','ASSIGN','تم تعيين الشكوى',4,5,4),
('NEW','IN_PROGRESS','ASSIGN','تم تعيين الشكوى',5,5,5),
('IN_PROGRESS','REVIEW','CHECK','تم مراجعة الشكوى',6,5,5),
('IN_PROGRESS','DONE','SOLVE','تم حل الشكوى',7,4,3);


-- Ratings
INSERT INTO rating (rating_value, note, complaint_id, account_id) VALUES
(5,'خدمة ممتازة',1,1),
(4,'تم حل المشكلة جزئياً',2,2),
(5,'تم الحل بسرعة',3,1),
(3,'المدة طويلة',4,2),
(4,'جيد لكن يحتاج متابعة',5,1),
(5,'ممتاز',6,2),
(2,'لم يتم حل المشكلة',7,1),
(4,'خدمة مرضية',8,2);

-- Voting
INSERT INTO voting (type, complaint_id, account_id) VALUES
('Upvote',1,1),
('Downvote',2,2),
('Upvote',3,1),
('Upvote',4,2),
('Downvote',5,1),
('Upvote',6,2),
('Downvote',7,1),
('Upvote',8,2);
