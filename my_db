
-- ===============================================
-- DROP DATABASE IF EXISTS
-- ===============================================
DROP DATABASE IF EXISTS complaint_monitoring_sys;

-- ===============================================
-- CREATE DATABASE
-- ===============================================
CREATE DATABASE IF NOT EXISTS complaint_monitoring_sys;
USE complaint_monitoring_sys;

SET FOREIGN_KEY_CHECKS = 0;


-- ===============================================
DROP TABLE IF EXISTS notification_receiver;
DROP TABLE IF EXISTS notification;
DROP TABLE IF EXISTS voting;
DROP TABLE IF EXISTS rating;
DROP TABLE IF EXISTS complaint_image;
DROP TABLE IF EXISTS complaint_tracking_log;
DROP TABLE IF EXISTS complaint;
DROP TABLE IF EXISTS employee;
DROP TABLE IF EXISTS citizen;
DROP TABLE IF EXISTS service;
DROP TABLE IF EXISTS address;
DROP TABLE IF EXISTS institution_governorate;
DROP TABLE IF EXISTS institution;
DROP TABLE IF EXISTS sector_governorate;
DROP TABLE IF EXISTS sector;
DROP TABLE IF EXISTS account;
DROP TABLE IF EXISTS governorate;
DROP TABLE IF EXISTS role;

-- ===============================================

-- TABLE: Role
CREATE TABLE role (
    id BIGINT NOT NULL PRIMARY KEY AUTO_INCREMENT,
    name VARCHAR(100) UNIQUE NOT NULL
) ENGINE=InnoDB;

-- TABLE: Governorate
CREATE TABLE governorate (
    id BIGINT NOT NULL PRIMARY KEY AUTO_INCREMENT,
    name VARCHAR(200) NOT NULL
) ENGINE=InnoDB;

-- TABLE: Sector
CREATE TABLE sector (
    id BIGINT NOT NULL PRIMARY KEY AUTO_INCREMENT,
    name VARCHAR(200) NOT NULL
) ENGINE=InnoDB;

-- TABLE: Sector_Governorate
CREATE TABLE sector_governorate (
    id BIGINT NOT NULL PRIMARY KEY AUTO_INCREMENT,
    sector_id BIGINT NOT NULL,
    governorate_id BIGINT NOT NULL,
    FOREIGN KEY (sector_id) REFERENCES sector(id),
    FOREIGN KEY (governorate_id) REFERENCES governorate(id)
) ENGINE=InnoDB;

-- TABLE: Institution
CREATE TABLE institution (
    id BIGINT NOT NULL PRIMARY KEY AUTO_INCREMENT,
    name VARCHAR(200) NOT NULL,
    sector_id BIGINT NOT NULL,
    FOREIGN KEY (sector_id) REFERENCES sector(id)
) ENGINE=InnoDB;

-- TABLE: Institution_Governorate
CREATE TABLE institution_governorate (
    id BIGINT NOT NULL PRIMARY KEY AUTO_INCREMENT,
    institution_id BIGINT NOT NULL,
    sector_governorate_id BIGINT NOT NULL,
    FOREIGN KEY (institution_id) REFERENCES institution(id),
    FOREIGN KEY (sector_governorate_id) REFERENCES sector_governorate(id)
) ENGINE=InnoDB;

-- TABLE: Account
CREATE TABLE account (
    id BIGINT NOT NULL PRIMARY KEY AUTO_INCREMENT,
    user_name VARCHAR(100) NOT NULL,
    email VARCHAR(255) UNIQUE,
    password VARCHAR(255) NOT NULL,
    state VARCHAR(50),
    dateTimeOfCreation DATETIME DEFAULT CURRENT_TIMESTAMP,
    national_number VARCHAR(20) UNIQUE NOT NULL,
    phone_number VARCHAR(50) NOT NULL,
    profile_image_url VARCHAR(500),
    role_id BIGINT NOT NULL,
    FOREIGN KEY (role_id) REFERENCES role(id)
) ENGINE=InnoDB;

-- TABLE: Citizen (Child of Account)
CREATE TABLE citizen (
    id BIGINT NOT NULL PRIMARY KEY,
    birth_date DATE,
    FOREIGN KEY (id) REFERENCES account(id) ON DELETE CASCADE
) ENGINE=InnoDB;

-- TABLE: Employee (Child of Account)
CREATE TABLE employee (
    id BIGINT NOT NULL PRIMARY KEY,
    is_manager BOOLEAN DEFAULT True,
    institution_id BIGINT NOT NULL,
    FOREIGN KEY (id) REFERENCES account(id) ON DELETE CASCADE,
    FOREIGN KEY (institution_id) REFERENCES institution(id)
) ENGINE=InnoDB;

-- TABLE: Address
CREATE TABLE address (
    id BIGINT NOT NULL PRIMARY KEY AUTO_INCREMENT,
    latitude DOUBLE NOT NULL,
    longitude DOUBLE NOT NULL,
    full_address_text VARCHAR(500)
) ENGINE=InnoDB;

-- TABLE: Service
CREATE TABLE service (
    id BIGINT NOT NULL PRIMARY KEY AUTO_INCREMENT,
    name VARCHAR(200) UNIQUE NOT NULL,
    description TEXT,
    is_active BOOLEAN DEFAULT TRUE,
    institution_id BIGINT NOT NULL,
    FOREIGN KEY (institution_id) REFERENCES institution(id)
) ENGINE=InnoDB;

-- TABLE: Complaint
CREATE TABLE complaint (
    id BIGINT NOT NULL PRIMARY KEY AUTO_INCREMENT,
    dateTimeOfAdd DATETIME DEFAULT CURRENT_TIMESTAMP,
    title VARCHAR(300) NOT NULL,
    description TEXT,
    current_state VARCHAR(100) default "New",
    dateTimeOfSolve DATETIME,
    added_by_account_id BIGINT NOT NULL,
    service_id BIGINT NOT NULL,
    institution_id BIGINT NOT NULL,
    governorate_id BIGINT NOT NULL,
    sector_id BIGINT NOT NULL,
    address_id BIGINT NOT NULL,
    FOREIGN KEY (added_by_account_id) REFERENCES account(id),
    FOREIGN KEY (service_id) REFERENCES service(id),
    FOREIGN KEY (institution_id) REFERENCES institution(id),
    FOREIGN KEY (governorate_id) REFERENCES governorate(id),
    FOREIGN KEY (sector_id) REFERENCES sector(id),
    FOREIGN KEY (address_id) REFERENCES address(id)
) ENGINE=InnoDB;

-- TABLES: Complaint_Image, Tracking, Rating, Voting, Notification, NotificationReceiver
CREATE TABLE complaint_image (
    id BIGINT NOT NULL PRIMARY KEY AUTO_INCREMENT,
    description TEXT,
    image_url VARCHAR(500),
    complaint_id BIGINT NOT NULL,
    FOREIGN KEY (complaint_id) REFERENCES complaint(id) ON DELETE CASCADE
) ENGINE=InnoDB;

CREATE TABLE complaint_tracking_log (
    id BIGINT NOT NULL PRIMARY KEY AUTO_INCREMENT,
    previous_status VARCHAR(100),
    new_status VARCHAR(100),
    action_type VARCHAR(100),
    comments TEXT,
    action_date DATETIME DEFAULT CURRENT_TIMESTAMP,
    complaint_id BIGINT NOT NULL,
    action_by_employee_id BIGINT,
    assigned_to_employee_id BIGINT,
    FOREIGN KEY (complaint_id) REFERENCES complaint(id),
    FOREIGN KEY (action_by_employee_id) REFERENCES employee(id),
    FOREIGN KEY (assigned_to_employee_id) REFERENCES employee(id)
) ENGINE=InnoDB;

CREATE TABLE rating (
    id BIGINT NOT NULL PRIMARY KEY AUTO_INCREMENT,
    rating_value INT,
    dateTimeOfRating DATETIME DEFAULT CURRENT_TIMESTAMP,
    note TEXT,
    complaint_id BIGINT NOT NULL,
    account_id BIGINT NOT NULL,
    FOREIGN KEY (complaint_id) REFERENCES complaint(id),
    FOREIGN KEY (account_id) REFERENCES account(id)
) ENGINE=InnoDB;

CREATE TABLE voting (
    id BIGINT NOT NULL PRIMARY KEY AUTO_INCREMENT,
    type VARCHAR(50),
    dateTimeOfVoting DATETIME DEFAULT CURRENT_TIMESTAMP,
    complaint_id BIGINT NOT NULL,
    account_id BIGINT NOT NULL,
    FOREIGN KEY (complaint_id) REFERENCES complaint(id),
    FOREIGN KEY (account_id) REFERENCES account(id)
) ENGINE=InnoDB;

CREATE TABLE notification (
    id BIGINT NOT NULL PRIMARY KEY AUTO_INCREMENT,
    title VARCHAR(200),
    message TEXT,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    realated_complaint_id BIGINT NOT NULL,
    FOREIGN KEY (realated_complaint_id) REFERENCES complaint(id)
) ENGINE=InnoDB;

CREATE TABLE notification_receiver (
    id BIGINT NOT NULL PRIMARY KEY AUTO_INCREMENT,
    is_read BOOLEAN DEFAULT FALSE,
    read_at DATETIME,
    notification_id BIGINT NOT NULL,
    account_id BIGINT NOT NULL,
    FOREIGN KEY (notification_id) REFERENCES notification(id),
    FOREIGN KEY (account_id) REFERENCES account(id)
) ENGINE=InnoDB;


SET FOREIGN_KEY_CHECKS = 1;

-- ===============================================
-- INSERTS
-- ===============================================

-- Roles
INSERT INTO role (name) VALUES
('مواطن'),
('موظف الاستقبال'),
('مدير'),
('أدمن');

-- Governorates
INSERT INTO governorate (name) VALUES
('دمشق'),
('حماه'),
('حمص'),
('اللاذقية');

-- Sectors
INSERT INTO sector (name) VALUES
('الكهرباء والطاقة'),
('المياه والصرف الصحي'),
('الاتصالات وتقنية المعلومات'),
('الطرق والنقل'),
('النظافة وإدارة النفايات'),
('الزراعة والري');

-- Sector_Governorate
INSERT INTO sector_governorate (sector_id, governorate_id) VALUES
(1, 1),(1, 2),      -- الكهرباء في دمشق وحماه
(2, 1),(2, 2),(2, 3),-- المياه في دمشق وحماه وحمص
(3, 1),(3, 4),      -- الاتصالات في دمشق واللاذقية
(4, 2),(4,3),       -- الطرق في حماه وحمص
(5,1),(5,4),        -- النظافة في دمشق واللاذقية
(6,2),(6,3);        -- الزراعة في حماه وحمص

-- Institutions
INSERT INTO institution (name, sector_id) VALUES
('شركة الكهرباء العامة',1),
('مديرية نقل الطاقة',1),
('مؤسسة مياه الشرب',2),
('مؤسسة الصرف الصحي',2),
('شركة الاتصالات الأرضية',3),
('شركة الاتصالات الخلوية',3),
('مركز خدمات الإنترنت',3),
('مديرية الطرق المركزية',4),
('مديرية النقل البري',4),
('مؤسسة تعبيد وصيانة الطرق الريفية',4),
('مديرية النظافة',5),
('ورشات جمع القمامة المتعاقدة',5),
('مؤسسة استصلاح الأراضي',6);

-- Institution_Governorate (ربط المؤسسة بمحافظات القطاع)
INSERT INTO institution_governorate (institution_id, sector_governorate_id) VALUES
(1,1),(1,2),           -- شركة الكهرباء العامة في دمشق وحماه
(3,2),(3,3),           -- مؤسسة مياه الشرب في دمشق وحماه
(4,2),(4,3),           -- مؤسسة الصرف الصحي في دمشق وحماه
(5,1),(5,12),          -- شركة الاتصالات الأرضية في دمشق واللاذقية
(11,1),(11,12);        -- مديرية النظافة في دمشق واللاذقية

-- Accounts (بعض الأمثلة)
INSERT INTO account (user_name,password,role_id,email,phone_number,national_number) VALUES
('ahmad.khaled','hashed_pwd',1,'ahmad@example.com','0999999999','05010565489'),
('sara.mohamed','hashed_pwd',1,'sara@example.com','0999998888','05010565789'),
('reception1','hashed_pwd',2,'reception1@example.com','0999977777','05010585489'),
('manager1','hashed_pwd',3,'manager1@example.com','0999966666','05010556489'),
('admin1','hashed_pwd',4,'admin1@example.com','0999955555','05010563389');
-- Citizen (linked to account)
INSERT INTO citizen (id,birth_date) VALUES
(1,'1990-01-01'),
(2,'1992-02-02');

-- Employee (linked to account and institution)
INSERT INTO employee (id,institution_id,is_manager) VALUES
(3,1,0),
(4,3,1),
(5,11,1);

-- Services
INSERT INTO service (name,institution_id,description) VALUES
('صيانة الاعطال في المنازل',1,'صيانة أعطال الكهرباء المنزلية'),
('اصلاح انقطاع التيار',1,'اصلاح الانقطاع الكهربائي'),
('معالجة شكاوى انقطاع المياه',3,'خدمة معالجة الانقطاع'),
('معالجة انخفاض ضغط المياه',3,'خدمة معالجة انخفاض الضغط');

